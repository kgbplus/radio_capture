{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Recordings</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportCSV()">Export CSV</button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="fileStreamFilter">
            <option value="">All Streams</option>
            {% for s in streams %}
            <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" id="fileDateFrom">
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" id="fileDateTo">
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary" onclick="loadFiles()">Filter</button>
    </div>
</div>

<!-- Audio Player -->
<div class="mb-3">
    <audio id="audioPlayer" controls style="width: 100%; display: none;">
        Your browser does not support the audio element.
    </audio>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>ID</th>
                <th>Stream</th>
                <th>Date</th>
                <th>Duration</th>
                <th>Size</th>
                <th>Status</th>
                <th>Classification</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="filesTableBody">
            <!-- Files injected here -->
        </tbody>
    </table>
    <nav>
        <ul class="pagination" id="pagination">
            <li class="page-item"><a class="page-link" href="#" onclick="changePage(-1)">Previous</a></li>
            <li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">Next</a></li>
        </ul>
    </nav>
</div>

<script>
    let currentPage = 0;
    const pageSize = 50;
    let currentPlayingId = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadFiles();
    });

    function playAudio(fileId) {
        const audioPlayer = document.getElementById('audioPlayer');
        const streamUrl = `/api/stats/files/${fileId}/stream`;

        // If clicking the same file that's playing, toggle pause/play
        if (currentPlayingId === fileId && !audioPlayer.paused) {
            audioPlayer.pause();
            updatePlayButton(fileId, false);
            return;
        }

        // Reset previous playing button if different file
        if (currentPlayingId !== null && currentPlayingId !== fileId) {
            updatePlayButton(currentPlayingId, false);
        }

        // Load and play new file
        audioPlayer.src = streamUrl;
        audioPlayer.style.display = 'block';
        audioPlayer.play();
        currentPlayingId = fileId;
        updatePlayButton(fileId, true);

        // Handle when audio ends
        audioPlayer.onended = () => {
            updatePlayButton(fileId, false);
            currentPlayingId = null;
        };
    }

    function updatePlayButton(fileId, isPlaying) {
        const button = document.getElementById(`play-btn-${fileId}`);
        if (button) {
            if (isPlaying) {
                button.innerHTML = '‚è∏Ô∏è Pause';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
            } else {
                button.innerHTML = '‚ñ∂Ô∏è Play';
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
            }
        }
    }

    async function classifyAudio(fileId) {
        const button = document.getElementById(`classify-btn-${fileId}`);
        const classificationCell = document.getElementById(`classification-${fileId}`);

        // Show loading state
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Classifying...';

        try {
            const response = await fetch(`/api/stats/files/${fileId}/classify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Classification failed');
            }

            const result = await response.json();

            // Update the classification cell with the result
            classificationCell.innerHTML = getClassificationBadge(result.classification);

            // Show success message briefly
            button.innerHTML = '‚úì Classified';
            button.classList.remove('btn-outline-warning');
            button.classList.add('btn-success');

            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-warning');
                button.disabled = false;
            }, 2000);

        } catch (error) {
            console.error('Classification error:', error);
            alert(`Classification failed: ${error.message}`);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    function getClassificationBadge(classification) {
        if (!classification) {
            return '<span class="badge bg-secondary">‚Äî</span>';
        }

        const badges = {
            'speech': '<span class="badge bg-primary">Speech</span>',
            'music': '<span class="badge" style="background-color: #6f42c1;">Music</span>',
            'ad': '<span class="badge bg-warning text-dark">Ad</span>'
        };

        return badges[classification] || '<span class="badge bg-secondary">Unknown</span>';
    }

    async function loadFiles(page = 0) {
        currentPage = page;
        const streamId = document.getElementById('fileStreamFilter').value;
        const dateFrom = document.getElementById('fileDateFrom').value;
        const dateTo = document.getElementById('fileDateTo').value;

        let url = `/api/stats/files?skip=${page * pageSize}&limit=${pageSize}`;
        if (streamId) url += `&stream_id=${streamId}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;

        const response = await fetch(url);
        const files = await response.json();
        const tbody = document.getElementById('filesTableBody');
        tbody.innerHTML = '';

        files.forEach(f => {
            const tr = document.createElement('tr');
            const date = new Date(f.start_ts).toLocaleString();
            const sizeMb = (f.size_bytes / (1024 * 1024)).toFixed(2);
            const duration = new Date(f.duration_seconds * 1000).toISOString().substr(11, 8);

            // Backend returns full recording object with joined stream.
            let streamName = f.stream_id;
            if (f.stream && f.stream.name) {
                streamName = f.stream.name;
            }

            tr.innerHTML = `
                <td>${f.id}</td>
                <td>${streamName}</td>
                <td>${date}</td>
                <td>${duration}</td>
                <td>${sizeMb} MB</td>
                <td>${f.status}</td>
                <td id="classification-${f.id}">${getClassificationBadge(f.classification)}</td>
                <td>
                    <button id="play-btn-${f.id}" class="btn btn-sm btn-outline-success me-1" onclick="playAudio(${f.id})">‚ñ∂Ô∏è Play</button>
                    <button id="classify-btn-${f.id}" class="btn btn-sm btn-outline-warning me-1" onclick="classifyAudio(${f.id})">üè∑Ô∏è Classify</button>
                    <a href="/api/stats/files/${f.id}/download" class="btn btn-sm btn-outline-primary">Download</a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function changePage(delta) {
        if (currentPage + delta < 0) return;
        loadFiles(currentPage + delta);
    }

    function exportCSV() {
        const streamId = document.getElementById('fileStreamFilter').value;
        const dateFrom = document.getElementById('fileDateFrom').value;
        const dateTo = document.getElementById('fileDateTo').value;

        let url = `/api/stats/files/export?`;
        if (streamId) url += `&stream_id=${streamId}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;

        window.location.href = url;
    }
</script>
{% endblock %}